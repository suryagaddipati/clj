(ns triplets)
(require '[clojure.core.reducers :as r])

(defn inc-map-by [incV m k]
  (if (nil? k) m (let [v (get m k 0)] (assoc m k (+ v incV)))))

(defn inc-v [m k]
  (if (vector? k) (get m (first k) 1)  1))

(defn incr-map [m & ks]
  (r/fold (r/monoid #(inc-map-by (inc-v %1 %2) %1 %2)  (constantly m)) ks))

(defn in-series? [x r]
  (or (= x 1) (= (rem x r) 0)))

(defn doublet [m x r]
  (let [quoti (quot x r)]
    (and (get m quoti) [quoti x])))

(defn prev-doublet [x r]
  (let [prev (quot x r)]
    [(quot prev r) prev]))

(defn foldTriplet [r xs x]
  (if-not (in-series? x r)  xs
          (let [m (first xs)
                sum (second xs)
                dblt (doublet m x r)
                pDblt (prev-doublet x r)
                pDbltCnt (get m pDblt 0)]
            ; (println dblt pDblt pDbltCnt)
            ; (println m)
            [(incr-map m  dblt x) (+ sum pDbltCnt)])))

(defn countTriplets [arr r]
  (second (r/fold (r/monoid (partial foldTriplet r) (constantly [{} 0])) arr)))

(countTriplets [1 883159100 531288700 190057300 151290300 718720100 402786700 289690000 492421700 35732600 918678200 9109700 679750500 78252800 316415300 587749600 350835900 665426700 767120400 529309500 130034100 492039900 23386800 194100900 637764700 284555300 755330400 309556600 325711300 929440600 627497900 35557300 507791300 771392800 308196000 281129700 741852000 494288900 436822400 553091300 977066400 517986200 410654400 231572100 365522700 995936300 148703700 278852800 476615100 872867200 262131100 242785700 439300000 74010600 731626000 197219200 582995400 821584400 929335400 430854900 138539800 233465700 625984200 690654500 615522600 581559300 849803800 312728000 440556300 400676300 703000700 69661600 224160600 664785000 585747400 84358000 865252500 556686200 141397700 479225400 18557400 910220000 277198700 874613900 302874600 135221100 515683100 6723500 22034700 653911200 929303700 556004300 413500700 220252900 895411100 893413400 451605200 191768600 483506200 240281100 119270300 11207000 936235700 19715900 476328300 334937400 451994400 669848600 687673600 667518200 218946700 292485500 789035800 565098200 95597000 200260000 315161700 182186000 737544200 946613400 76872600 421936100 536594700 404972900 965828300 141885300 650446500 904145800 900564500 378257700 420187500 778717400 229741100 299742200 664472100 253600700 288076500 576426100 533985100 123731100 606484900 660553800 206571500 65060000 688725300 965009800 399910700 223759000 308229800 871070200 155838000 418992500 712217600 151798000 540184900 374367300 248695100 872683900 50266700 581221100 342753600 596166100 80193900 827891600 59154700 580123900 159936400 314822900 771002400 671408500 629535900 769798800 646607600 643025400 950652100 524895100 557415100 948176400 68026900 486243300 939990800 380006400 795530600 74485100 162842300 607163700 55156200 617703800 415327800 132365200 717705300 880206600 230793800 503479800 68831200 95728500 858857900 973598000 652009500 212872300 19900300 361791600 946116600 871754100 29301700 146887100 54872400 835246500 934038200 621746400 391653100 37410700 332216100 803284300 195180600 68594500 761205200 132533000 139018300 834750100 666539600 56997500 491862400 897772400 723043600 463622100 882112800 978528900 166854900 297181000 550935800 740878700 906095700 897633900 271489100 728392200 235846300 519798000 55680300 315741700 543830100 545250000 614056800 880173200 422240300 55024000 752909900 993820100 780447000 574799900 357273300 840705200 589473200 68758300 779553100 374662800 99888200 124665200 585777900 782908100 151439700 805848100 46547000 780355400 29545000 772127700 594997000 998616800 406059300 678836400 638529300 245522400 794274200 130631600 493974500 6499300 191323500 451180600 152702600 924080100 245266400 742121200 66914600 48106700 738647900 976509300 59815600 423211700 113096600 60927100 378900700 337615800 95311200 521426000 781746900 780558200 103201000 84049900 761028400 741649000 123599800 143356600 910151700 660574800 519697500 488368100 107105600 457992000 817836800 522741500 426744400 341091600 249729000 881013800 768283300 727482000 79205800 342649200 342455000 221431600 315107500 658647800 218735500 592188300 529367800 60894600 906486500 455104700 114309800 261714500 339624100 36271800 259916800 9861200 138477400 67209000 36454300 307893800 22624400 490494600 811102000 880750400 60792600 841186600 507868800 110011200 52285300 199690300 73681700 557855000 777358400 477424300 919751300 919852900 782654100 33361900 208485800 868136300 741603200 169011900 490180200 27251300 70282800 422078300 554512500 684604000 993278500 4875400 985998400 379113400 840648100 273168100 280013800 58985700 207213700 213210600 573795600 324445100 500436000 680478500 41685300 726203300 742252200 700260600 93356600 152495900 770945000 60799800 900234500 715828000 826479400 750004500 825120300 884879900 458930800 958574700 563313300 35350200 109883100 16350500 79023100 621432100 12881800 872442100 738736900 132085600 705216400 800652700 809317000 104527300 49032100 145430600 234613900 874252200 570989800 64178300 142617300 386375800 802971900 378452800 81432800 560262000 624376000 614494200 749303800 801209700 100074600 20814400 763874600 448916100 33450800 383071900 374865500 435462600 514391400 528655700 18019700 900781400 784340600 395900400 766881200 737623600 837487200 489309700 973531800 102016700 654795300 451343800 840559600 992416000 340299500 237698600 177471300 42465200 779464300 231741300 569663700 29225500 239254500 132570300 758374300 556544600 141292800 41241100 362220800 114985000 283536000 707027100 29664100 452826100 259043600 936817300 66136000 448344000 264375900 699662200 486617700 586363100 672951900 748344900 59431400 536919400 776922300 4604400 865535900 575400100 379016800 766653200 876617800 299125900 212539700 569643900 585033300 520441400 842509000 620433700 444983900 960090000 617115300 649227500 239921700 316520800 742339000 575892100 739588200 464710000 451853600 840881700 15411900 698511900 434307600 654629000 219472200 276088600 269728100 30437200 43332300 292062400 530738200 884625300 450067800 92174000 585282400 650594100 49703500 172480800 614425000 704190100 147327500 295867400 588977000 547597900 55850700 741563900 155857600 568118500 115102200 31758300 157315600 116299100 335843200 936070700 979725100 892905600 715722800 110394800 752596900 940673700 73144000 283773600 300767600 89789800 664805000 490613300 39432400 69784900 317894200 214304600 926514800 303654700 203619600 150462900 975051600 910261600 400887800 400098900 395326600 889412000 94857700 98177800 500735400 294491900 126104200 245777600 514588200 149318400 713184100 956505500 736539000 395778300 350489400 341959700 620398200 753175000 847248900 955360700 856531300 76875000 10641600 765271000 10949200 745462000 488583100 283237300 604539300 401570300 475441300 295922400 298132000 714398200 986057600 731524500 301373500 715780000 906106900 367730600 81752700 261294200 738709800 674359300 790207500 823806700 729044500 644553100 29283600 3898200 104834600 700768000 297206000 286087200 73889400 189899500 815190600 274803900 92997700 435521100 791478000 135662300 563364900 288026900 858191000 346115200 828668100 706181600 888771600 362059200 532171600 481663200 147681900 139734800 286643300 592905400 302041500 643825500 230898100 305070100 91903300 394194400 234825400 22423300 727024600 795156600 563129900 974983600 766232300 521380200 36194400 603426200 580624600 77582600 468206800 10483800 742488700 905659800 29067400 361749200 109780100 824810400 379178300 454663700 52305300 870696900 651715200 579325500 78129000 811886900 301265800 901203200 865519800 514667600 72550900 517955700 32461700 805176200 519402500 931651000 914000800 14962300 657651400 890737200 32254600 256131100 748835100 280114100 71020200 440033300 930189900 158275700 283702200 585395000 834185700 212218700 639315700 715584500 895057200 417700100 209140500 710528900 637079000 38782100 190766900 628051700 727900000 114379900 303671600 584238200 80900400 584660900 705392800 520289600 173584100 440653300 338680600 215257900 406378400 767032700 117324000 670057200 653515300 943002200 129896500 674051700 21755600 334090000 354301400 885789000 29740200 613793000 52131300 636538800 653412800 86047000 4393400 502016800 247087300 285562900 306390400 730376300 410140200 146969200 713625600 383710500 34196700 859410900 858158900 98650800 538232100 28658000 422139100 21748900 725263000 911396200 365714500 69490900 581981400 27809700 650897200 422709200 974360400 123448300 120258000 477645000 53717000 179957900 730815000 621815400 48698200 41725500 682525500 61224800 421382700 994804000 456670200 808193200 562620200 311861800 947282000 806634100 69395800 959090600 72243600 643646200 370783400 192332000 758574900 794774400 977387700 308437800 462465500 630273200 239586700 271133500 115687300 525606900 769572000 288682600 995071400 20904700 339998700 131295800 606522000 658478600 586364300 611881300 317069900 251157400 698820300 148217900 916526200 592309200 188832300 798262000 862924700 191039800 661902200 189573000 278529000 237474100 93574600 704551900 125783400 734533200 498812600 592112400 831568600 621302000 60517000 386998400 860330000 903821000 904872800 658235100 290315100 472017700 499259700 349110500 22432000 392604600 755669200 338303500 753870800 581965100 466661300 154853500 376576100 913859800 102499300 243544800 661839900 636270900 977988600 379602200 442419300 301212500 637035800 672044400 469635900 174485300 718960000 915855800 446903500 572784900 568401500 97096800 538912000 652662600 671743600 8820700 494019800 683672500 23304000 595928800 955561400 128992200 965976700 79569700 721640400 929953300 37702300 120941400 7585000 569853300 30752300 546354100 26439700 57914200 151094300 48763600 649342300 694753000 481983200 40687300 228571200 207819100 34926500 794603000 341246100 175131900 653661100 500576400 101265100 591951600 65555800 3474000 113584300 689865700 668198500 743767000 116288300 596406900 894912000 57788900 236236100 18610700 483134500 452336700 172780600 732015600 279673500 507211900 908884300 376182400 121273900 716069000 127912300 494260000 569830500 261417200 245032900 794750700 111487300 940981800 199824900 574528200 770591300 576346200 365387500 554193000 94592900 920011800 326810200 245966800 220964900 80266800 682741000 487032400 445774700 712249200 998167200 918999000 908047600 358863700 729894200 803038200 48060400 946691700 485978200 102462100 394419800 467552200 481359600 138098800 913347100 827208000 808605500 972287700 715240600 991719000 5092900 22274800 33911900 718782700 70593400 530034600 781036700 276288500 21065700 1687200 183630100 292712900 90706100 635340500 538370700 849214000 61193700 342854600 748053700 414091500 110268600 780371200] 100)
; (countTriplets [1 1 1] 1)
; (countTriplets [1 3 9 9 27 81] 3)
